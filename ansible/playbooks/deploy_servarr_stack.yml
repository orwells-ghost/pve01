- name: Deploy servarr stack into CT150
  hosts: proxmox
  gather_facts: false

  vars:
    ct_id: 150

    # compose file path (relative to ansible/ directory)
    local_compose_path: "{{ playbook_dir }}/../../servarr/docker-compose.yml"
    staged_compose_path: "/tmp/servarr-docker-compose.yml"
    ct_compose_path: "/config/docker-compose.yml"

  tasks:
    - name: Check current CT150 config for mp1
      shell: |
        set -euo pipefail
        pct config {{ ct_id }} | grep -E '^mp1:' || true
      args:
        executable: /bin/bash
      register: mp1_line
      changed_when: false

    - name: Ensure mp1 media bind mount is set (host {{ media_host_path }} -> CT {{ media_ct_path }})
      shell: |
        set -euo pipefail
        pct set {{ ct_id }} -mp1 {{ media_host_path }},mp={{ media_ct_path }}
      args:
        executable: /bin/bash
      when: mp1_line.stdout | length == 0

    - name: Reboot CT150 if mp1 was added
      shell: |
        set -euo pipefail
        pct reboot {{ ct_id }}
      args:
        executable: /bin/bash
      when: mp1_line.stdout | length == 0

    - name: Create media directory structure inside CT
      shell: |
        set -euo pipefail
        pct exec {{ ct_id }} -- bash -lc '
          set -euo pipefail
          {% for d in media_dirs %}
          mkdir -p {{ media_ct_path }}/{{ d }}
          {% endfor %}
        '
      args:
        executable: /bin/bash

    - name: Verify local compose exists (control node)
      delegate_to: localhost
      run_once: true
      stat:
        path: "{{ local_compose_path }}"
      register: compose_stat

    - name: Fail if local compose missing
      delegate_to: localhost
      run_once: true
      fail:
        msg: "Local compose file not found: {{ local_compose_path }}"
      when: not compose_stat.stat.exists

    - name: Upload compose to Proxmox host staging path
      copy:
        src: "{{ local_compose_path }}"
        dest: "{{ staged_compose_path }}"
        mode: "0644"

    - name: Push compose from Proxmox host into CT150 /config (and verify)
      shell: |
        set -euo pipefail
        pct push {{ ct_id }} "{{ staged_compose_path }}" "{{ ct_compose_path }}"
        pct exec {{ ct_id }} -- bash -lc 'ls -la {{ ct_compose_path }} && head -n 5 {{ ct_compose_path }}'
      args:
        executable: /bin/bash

    - name: Bring up servarr stack
      shell: |
        set -euo pipefail
        pct exec {{ ct_id }} -- bash -lc '
          set -euo pipefail
          ls -la /config
          test -f /config/docker-compose.yml
          docker compose -f /config/docker-compose.yml pull
          docker compose -f /config/docker-compose.yml up -d
          docker ps
        '
      args:
        executable: /bin/bash
